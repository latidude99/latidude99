{% extends "snc/base.html" %}
{% load static %}
{% static "snc/" as static_base %}
{% load humanize %}


{#  ----------------------------------- CHARTS --------------------------------------------- #}
{% block content_left %}

    <div id="zoomLevel"></div>
    <div id="map-canvas"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key_dev_un }}&callback=initMap"></script>

    <script>

        var map;
        var infoWindow;

        function initialize() {
            var mapOptions = {
                zoom: 5,
                center: new google.maps.LatLng(0.00, 0.00),
                mapTypeId: google.maps.MapTypeId.ROAD
            };

            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
            infoWindow = new google.maps.InfoWindow();
            var markers = [];

            {% for chart in  charts %}
                <!-- ---------------- chart ---------------- -->
                {% if chart.polygons|length > 0 %}
                    {% for polygon in  chart.polygons %}
                        var chart_{{ chart.number }}_poly = new google.maps.Polygon({
                            paths: [
                                {% for position in  polygon.positions %}
                                    new google.maps.LatLng({{ position.lat }}, {{ position.lon }}),
                                {% endfor %}
                            ],
                            strokeColor: '{{ colour }}',
                            strokeOpacity: 0.8,
                            clickable: true,
                            strokeWeight: '2',
                            fillColor: '{{ chart.colour }}',
                            fillOpacity: '0.05',
                            number: '{{ chart.number }}',
                            type: 'chart',
                            name: '{{ chart.title }}',
                            scale: '1:{{ chart.scale|intcomma }}',
                            zoomMax: '{{ chart.zoom_max }}',
                            zoomMin: '{{ chart.zoom_min }}',
                            map: map,
                            zIndex: '{{ chart.zoom_max }}'
                        });

                        google.maps.event.addListener(chart_{{ chart.number }}_poly, 'click', showInfo);

                        var chart_{{ chart.number }}_marker = new google.maps.Marker({
                            map: map,
                            position: new google.maps.LatLng(
                                {{ chart.label_position.lat }}, {{ chart.label_position.lon }}),
                            icon: " ",
                            draggable: false,
                            clickable: true,
                            visible: true,
                            zoomMax: '{{ chart.zoom_max }}',
                            zoomMin: '{{ chart.zoom_min }}',
                            label: {
                                text: '{{ chart.number }}',
                                color: '{{ chart.colour }}',
                                fontSize: '16px',
                                fontShadow: "6px",
                                fontWeight: "regular"
                            }
                        });
                        markers.push(chart_{{ chart.number }}_marker);
                    {% endfor %}
                {% else %}
                    {# no chart polygon #}
                {% endif %}

                {% if chart.panels|length > 0 %}
                    {% for panel in  chart.panels %}
                        <!-- ---------------- panel ---------------- -->
                        {% for poly in  panel.polygons %}
                            var panel_{{ panel.panel_id }}_of_{{ chart.number }}_poly
                                = new google.maps.Polygon({
                                paths: [
                                    {% for pos in  poly.positions %}
                                        new google.maps.LatLng({{ pos.lat }}, {{ pos.lon }}),
                                    {% endfor %}
                                ],
                                strokeColor: '{{ colour }}',
                                strokeOpacity: 0.8,
                                clickable: true,
                                strokeWeight: '1',
                                strokeDasharray: '-',
                                fillColor: '{{ panel.colour }}',
                                fillOpacity: '0.2',
                                number: '{{ chart.number }} ({{ panel.panel_id }})',
                                type: 'panel',
                                name: '{{ panel.name }}',
                                scale: '{{ panel.scale }}',
                                zoomMax: '{{ chart.zoom_max }}',
                                zoomMin: '{{ chart.zoom_min }}',
                                map: map,
                                zIndex: '{{ chart.zoom_max }}'
                            });

                            google.maps.event.addListener(
                                panel_{{ panel.panel_id }}_of_{{ chart.number }}_poly, 'click', showInfo);

                            var marker_{{ panel.panel_id }}_of_{{ chart.number }}_poly
                                = new google.maps.Marker({
                                map: map,
                                position: new google.maps.LatLng(
                                    {{ panel.label_position.lat }}, {{ panel.label_position.lon }}),
                                icon: " ",
                                draggable: false,
                                clickable: true,
                                visible: true,
                                zoomMax: '22',
                                zoomMin: '8',
                                label: {
                                    text: '{{ chart.number }} panel {{ panel.panel_id }}/{{ chart.panels|length }}',
                                    color: '{{ panel.colour }}',
                                    fontSize: '12px',
                                    fontShadow: "6px",
                                    fontWeight: "regular"
                                }
                            });
                            markers.push(marker_{{ panel.panel_id }}_of_{{ chart.number }}_poly);
                        {% endfor %}
                        <!-- ---------------- panel end ---------------- -->
                    {% endfor %}
                {% endif %}
            {% endfor %}
            <!-- ---------------- chart end ---------------- -->
            var polygons = new Array(
                {% for chart in  charts %}
                    {% if chart.polygons|length > 0 %}
                        chart_{{ chart.number }}_poly,
                    {% endif %}
                    {% for panel in  chart.panels %}
                        {% if panel.polygons|length > 0 %}
                            panel_{{ panel.panel_id }}_of_{{ chart.number }}_poly,
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            );

            google.maps.event.addListener(map, 'zoom_changed', function () {
                var zoom = map.getZoom();

                for (i = 0; i < polygons.length; i++) {
                    if (zoom < polygons[i].zoomMin)
                        polygons[i].setMap(null);
                    else if (zoom > polygons[i].zoomMax)
                        polygons[i].setMap(null);
                    else
                        polygons[i].setMap(map);
                }
                for (i = 0; i < markers.length; i++) {

                    if (zoom < markers[i].zoomMin)
                        markers[i].setMap(null);
                    else if (zoom > markers[i].zoomMax)
                        markers[i].setMap(null);
                    else
                        markers[i].setMap(map);
                }
                document.getElementById("zoomLevel").innerHTML = 'Zoom Level: ' + zoom;
            });

            var bounds = new google.maps.LatLngBounds();
            for (var i = 0; i < polygons.length; i++) {
                var paths = polygons[i].getPaths();
                console.log(polygons[i])
                console.log(paths)
                paths.forEach(function (path) {
                    var ar = path.getArray();
                    for (var i = 0, l = ar.length; i < l; i++) {
                        bounds.extend(ar[i]);
                    }
                })
            }
            map.fitBounds(bounds)
            map.setCenter(bounds.getCenter());
        }


        function showInfo(event) {
            var vertices = this.getPath();

            var chartInfo = '<b>' + this.number + '</b><br>' +
                '<sup>' + this.type + '</sup><br>' +
                this.name + '</b><br>' +
                this.scale + '</b><br>';


            infoWindow.setContent(chartInfo);
            infoWindow.setPosition(event.latLng);

            infoWindow.open(map);
        }

        google.maps.event.addDomListener(window, 'load', initialize);

    </script>


{% endblock %}



{#  ----------------------------------- INFO --------------------------------------------- #}
{% block content_right %}

    <p style="color:red;">
        {{ search_single_error }}
    </p>

    <div class="info_text" style="border-left: darkgrey solid 1px"></div>

    {% for chart in  charts %}
        <!-- charts accordion start -->
        <div id="chart_acc">
            <div class="card bg-transparent" style="border:none;">
                <div class="card-header bg-transparent" style="border:none;">
                    <a class="card-link panel-heading" data-toggle="collapse" id="acc_head"
                       data-target="#info_chart_main" aria-expanded="true" aria-controls="info_main"
                       style="text-decoration: none; cursor:pointer;
                               font-size:16px; color:grey;">
                        <i class="fa mr-3" style="font-size:14px;color:grey;" aria-hidden="false"></i>
                        chart details
                    </a>
                    <hr>

                    <div id="info_chart_main" class="collapse show" data-parent="#accordion"
                         aria-labelledby="info_main_head" style="color:#96281b;">
                        <div style="">
                            <p style="margin-bottom: 2px">
                                Chart number:
                                <span style="color:navy;font-size:17px;">
                                        {{ chart.number }}</span>
                            </p>
                            <p style="margin-bottom: 2px">
                                Chart title:
                                <span style="color:navy;font-size:17px;">
                                        {{ chart.title }}</span>
                            </p>
                            {% if chart.polygons|length > 0 %}
                                <p style="margin-bottom: 2px">
                                    Chart scale:
                                    <span style="color:navy;font-size:17px;">
                                        1 : {{ chart.scale|intcomma }}</span>
                                </p>
                            {% else %}
                                <p style="margin-bottom: 2px">
                                Chart scale:
                                <span style="color:navy;font-size:17px;">
                                        no main polygon</span>
                            {% endif %}
                            <p style="margin-bottom: 2px">
                                Status:
                                <span style="color:navy;font-size:17px;">
                                        {{ chart.status }}</span>
                                <span style="color:navy;font-size:17px;">
                                        , {{ chart.status_date }}</span>
                            </p>
                            <p style="margin-bottom: 2px">
                                New edition date:
                                <span style="color:navy;font-size:17px; margin-right:15px;">
                                        {{ chart.new_edition_date }}</span>
                            </p>
                            <p style="margin-bottom: 2px">
                                Last NM number:
                                {% if chart.last_nm_number == '' %}
                                    <span style="color:grey;font-size:17px; margin-right:15px;">
                                         none</span>
                                {% else %}
                                    <span style="color:navy;font-size:17px; margin-right:15px;">
                                        {{ chart.last_nm_number }}</span>
                                {% endif %}
                            </p>
                            <p style="margin-bottom: 2px">
                                Last NM date (week-year):
                                {% if chart.last_nm_date == '' %}
                                    <span style="color:grey;font-size:17px; margin-right:15px;">
                                         none</span>
                                {% else %}
                                    <span style="color:navy;font-size:17px; margin-right:15px;">
                                        {{ chart.last_nm_date }}</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- panels accordion start -->
        <div>
            <div class="card bg-transparent" style="border:none;">
                <div class="card-header bg-transparent" style="border:none;">
                    <a class="card-link panel-heading collapsed" data-toggle="collapse" id="acc_head"
                       data-target="#info_chart_panels" aria-expanded="true" aria-controls="info_main"
                       style="text-decoration: none; cursor:pointer;
                               font-size:16px; color:grey;">
                        <i class="fa mr-3" style="font-size:14px;color:grey;" aria-hidden="true"></i>
                        panels ({{ chart.panels|length }})
                    </a>
                    <hr>
                    <div id="info_chart_panels" class="collapse" data-parent="#accordion"
                         aria-labelledby="info_main_head" style="color:#96281b;">
                        <div id="panels" class="scroll-hidden">
                            {% if chart.panels|length > 0 %}
                                {% for panel in chart.panels %}
                                    <p style="margin-bottom: 1px">
                                        panel id:
                                        <span style="color:navy;font-size:17px;">
                                        {{ panel.panel_id }}</span>
                                    </p>
                                    <p style="margin-bottom: 1px">
                                        panel name:
                                        <span style="color:navy;font-size:17px;">
                                        {{ panel.name }}</span>
                                    </p>
                                    <p style="margin-bottom: 10px">
                                        panel scale:
                                        <span style="color:navy;font-size:17px;">
                                        1 : {{ panel.scale|intcomma }}</span>
                                    </p>
                                {% endfor %}
                            {% else %}
                                <p style="color:grey;font-size:17px; margin-left:15px;">
                                    none</p>
                            {% endif %}
                            <hr>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- panels accordion end -->

        <!-- notices accordion start -->
        <div>
            <div class="card bg-transparent" style="border:none;">
                <div class="card-header bg-transparent" style="border:none;">
                    <a class="card-link panel-heading collapsed" data-toggle="collapse" id="acc_head"
                       data-target="#info_chart_notices" aria-expanded="true" aria-controls="info_main"
                       style="text-decoration: none; cursor:pointer;
                               font-size:16px; color:grey;">
                        <i class="fa mr-3" style="font-size:14px;color:grey;" aria-hidden="true"></i>
                        notices ({{ chart.notices|length }})
                    </a>
                    <hr>
                    <div id="info_chart_notices" class="collapse" data-parent="#accordion"
                         aria-labelledby="info_main_head" style="color:#96281b;">
                        <div id="notices" class="scroll-hidden">
                            {% if chart.notices|length > 0 %}
                                {% for notice in chart.notices %}
                                    <p style="margin-bottom: 5px">
                                        number:
                                        <span style="color:navy;font-size:17px;">
                                        {{ notice.number }}</span>
                                        , week:
                                        <span style="color:navy;font-size:17px;">
                                        {{ notice.week }}</span>
                                        <span style="color:navy;font-size:17px;">
                                    , year:
                                            {{ notice.year }}</span>
                                        <span style="color:grey;font-size:14px;">
                                         / {{ notice.type }}</span>
                                    </p>
                                {% endfor %}
                            {% else %}
                                <p style="color:grey;font-size:17px; margin-left:15px;">
                                    none</p>
                            {% endif %}
                            <hr>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- notices accordion end -->
    {% endfor %}


{% endblock %}

